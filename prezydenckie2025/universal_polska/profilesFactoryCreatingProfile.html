<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tworzenie Profili – Votinga</title>
  <link rel="stylesheet" href="console-style.css" />
  <style>
    button p{
      font-size: 2em;
    }
    .tx-levels {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    .tx-button {
      padding: 10px 16px;
      border: 2px solid transparent;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
    }
    .tx-button.selected {
      border: 7px solid rgb(83, 33, 201);
    }
    .tx-basic {
      background-color: white;
      color: black;
    }
    .tx-premium {
      background-color: gold;
      color: black;
    }
    .tx-plat {
      background-color: indigo;
      color: white;
    }
  </style>
</head>
<body>

<div class="tx-levels">
  <button class="tx-button tx-basic" onclick="setTxLevel('basic')" id="btn-basic">Transakcje Podstawowe</button>
  <button class="tx-button tx-premium selected" onclick="setTxLevel('premium')" id="btn-premium">Transakcje Premium</button>
  <button class="tx-button tx-plat" onclick="setTxLevel('plat')" id="btn-plat">Transakcje Platynowe</button>
</div>

<div id="messageBox">
⚠️ Uwaga – Tworzenie Profili Obywatelskich

Zanim przystąpisz do tworzenia profilu:
- Potwierdź swój adres portfela - tylko potwierdzone adresy, że należą i są kontrolowane przez człowieka, mogą stworzyć profil

- Profil będzie publiczny na blockchainie – nie można go później usunąć.

- Dane mogą być użyte w procesach walidacji i głosowania.

Postępuj uważnie. Wybór poziomu transakcji zmieni czas rejestracji.

Po stworzeniu profilu Potwierdź swoją tożsamość i obywatelstwo z pomocą społeczności wokół Votinga.
</div>

<h1>Tworzenie Profilu Tożsamości – Fabryka Profili</h1>
<select id="abiSelector"></select>
<button onclick="loadSelectedContract()">Pokaż funkcje kontraktu</button>
<div id="contractFunctions"></div>

<script src="./ethers.umd.js"></script>
<script>
const abiFolderPath = './1profilesFactoryJustCreate/';
const files = ['0xa029c1c1710fc74dbeb125ce02c9a3469ca8079f.PolskaFabrykaProfiliVotinga.abi'];
let txLevel = 'basic';

function setTxLevel(level) {
  txLevel = level;
  document.querySelectorAll('.tx-button').forEach(btn => btn.classList.remove('selected'));
  document.getElementById('btn-' + level).classList.add('selected');
}

function listABIs() {
  const selector = document.getElementById('abiSelector');
  files.forEach(file => {
    const option = document.createElement('option');
    option.value = file;
    option.innerText = file.split('.abi')[0];
    selector.appendChild(option);
  });
}

async function loadSelectedContract() {
  const selector = document.getElementById('abiSelector');
  const abiFile = selector.value;
  const contractAddress = abiFile.split('.')[0];
  const contractABI = await fetch(abiFolderPath + abiFile).then(response => response.json());
  loadContractFunctions(contractAddress, contractABI);
}

async function loadContractFunctions(contractAddress, contractABI) {
  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const contract = new ethers.Contract(contractAddress, contractABI, signer);
  const container = document.getElementById('contractFunctions');
  container.innerHTML = '';

  contractABI.forEach(func => {
    if (func.type === "function") {
      const funcDiv = document.createElement('div');
      funcDiv.className = func.stateMutability;

      const button = document.createElement('button');
      button.textContent = func.name;
      button.className = func.stateMutability;

      const inputsDiv = document.createElement('div');
      func.inputs.forEach(input => {
        const inputLabel = document.createElement('label');
        inputLabel.textContent = input.name + ' (' + input.type + '): ';
        const inputElement = document.createElement('input');
        inputElement.setAttribute('id', func.name + '_' + input.name);
        inputElement.setAttribute('type', 'text');
        inputsDiv.appendChild(document.createElement('br'));
        inputsDiv.appendChild(inputLabel);
        inputsDiv.appendChild(inputElement);
      });

      button.addEventListener('click', async () => {
        const args = func.inputs.map(input => {
          return document.getElementById(func.name + '_' + input.name).value;
        });

        try {
          let result;
          if (func.stateMutability !== 'view' && func.stateMutability !== 'pure') {
            let value;
            if (txLevel === 'premium') value = ethers.parseEther("0.001");
            else if (txLevel === 'plat') value = ethers.parseEther("0.071");
            else value = ethers.parseEther("0");
            result = await contract[func.name](...args, { value });
          } else {
            result = await contract[func.name](...args);
          }

          let formatted = typeof result === 'object'
            ? JSON.stringify(result, null, 2)
            : String(result);
          formatted = formatted
            .replace(/{/g, '\n{\n')
            .replace(/}/g, '\n}\n')
            .replace(/,/g, '\n')
            .replace(/\[/g, '\n[\n')
            .replace(/\]/g, '\n]\n');
          document.getElementById('messageBox').innerText = formatted;
        } catch (error) {
          document.getElementById('messageBox').innerText = 'Błąd: ' + error.message;
        }
      });

      funcDiv.appendChild(button);
      funcDiv.appendChild(inputsDiv);
      container.appendChild(funcDiv);
    }
  });
}

function encrypt() {
  const peselInput = document.getElementById('pesel').value;
  const encryptedUniqueId = ethers.keccak256(ethers.toUtf8Bytes(peselInput));
  document.getElementById('encryptedUniqueId').value = encryptedUniqueId;
  document.getElementById('stworzProfilEwolucyjnyENGcreateProfileUpgradeable__uniqueId').value = encryptedUniqueId;
  document.getElementById('stworzProfilENGcreateProfile__uniqueId').value = encryptedUniqueId;
  
}

window.addEventListener('DOMContentLoaded', async () => {
  listABIs();
  try {
    if (!window.ethereum) return;
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    const address = await signer.getAddress();
    const balance = await provider.getBalance(address);
    const ethBalance = parseFloat(ethers.formatEther(balance));

    console.log('Adres:', address);
    console.log('Saldo ETH:', ethBalance);

    if (ethBalance < 0.002) {
      setTxLevel('basic');
    } else if (ethBalance >= 0.002 && ethBalance < 0.2) {
      setTxLevel('premium');
    } else {
      setTxLevel('plat');
    }
  } catch (err) {
    console.warn("Błąd pobierania salda:", err.message);
  }
});
</script>

<h2>UniqueID Encryption</h2>
<form id="encryptionForm">
    <label for="pesel">UniqueID (Your PESEL): do porównania z wczytanym </label>

    <input type="text" id="pesel" name="pesel">
    <button type="button" onclick="encrypt()">Encrypt / Szyfrowanie </button><br><br>

    <label for="encryptedUniqueId">Encrypted / Zaszyfrowany UniqueID Pamiętaj zamienić końcowe znaki na D1 D2 ... DN jeśli to konto reaktywowane po utracie kluczy itp:</label>
    <input type="text" id="encryptedUniqueId" name="encryptedUniqueId" readonly>
</form>
<br> Czyli jeśli po encypcji PESELU masz hash 0x0000abcd .... 0102cdA to jeśli to duplikat
<br> bo zgubiłeś/aś klucze to na końcu 0x0000abcd......0102cD1 robisz zamieniasz tu dA na D1
<br> jeśli zgubisz 100 razy klucz to duplikat wtedy ma końcówkę D100 i zamieniasz ostatnie 4 znaki
<br> zasadniczo teraz pierwsza walidacja jest darmowa z pewnymi wyjątkami, ale walidacje duplikatów prawie zawsze będą odpłatne.
<br> Pozdrawiamy.

<br>
<br>

Pamiętaj o weryfikacji profilu u walidatora.
Pamiętaj o nadaniu profilowi obywatelstwa PL, jeśli takie posiadasz walidator potwierdzi.
Walidatorów znajdziesz na forum Discord i lokalnych spotkaniach.
 <h3>
Votinga:</h3>

<br>
<p>Exploratory bloków przykładowe dla sieci <b>Optimistic</b> <br>
tu możesz sprawdzić transakcje wychodzace z twego portfela, potwierdzenia i rzeczywistą kreację profilu na blockchainie.
</p>
<br>
Podgląd zawartości profilu znajdziesz w opcji menu podlgąd profilu.
<br>
<button onclick="window.location.href=https://optimistic.etherscan.io/"><p><br>Optimistic etherscan</p></button><br>
<br>
<button onclick="window.location.href=https://optimism.blockscout.com/"><p><br>Optimistic block scout <br></p></button><br>

</body>
</html>
