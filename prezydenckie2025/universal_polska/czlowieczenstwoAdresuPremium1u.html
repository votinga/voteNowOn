
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Człowieczeństwo Adresu – Votinga</title>
  <link rel="stylesheet" href="console-style.css" />
  <style>
    .tx-levels {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    .tx-button {
      padding: 10px 16px;
      border: 2px solid transparent;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
    }
    .tx-button.selected {
      border: 7px solid rgba(146, 1, 146, 0.856);
    }
    .tx-basic {
      background-color: white;
      color: black;
    }
    .tx-premium {
      background-color: gold;
      color: black;
    }
    .tx-plat {
      background-color: indigo;
      color: white;
    }
    #messageBox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        max-height: 200px;
        background: linear-gradient(90deg, #f1f1f1, #e3e3e3);
        border-bottom: 2px solid #bbb;
        padding: 15px;
        box-sizing: border-box;
        overflow-y: auto;
        font-family: Arial, sans-serif;
        font-size: 14px;
        color: #222;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #returnButton {
        position: fixed;
        bottom: 15px;
        left: 15px;
        padding: 10px 16px;
        background-color: #d3d3d3;
        border: 2px solid #888;
        border-radius: 10px;
        font-weight: bold;
        text-decoration: none;
        color: black;
    }
    #returnButton:hover {
        background-color: #bdbdbd;
    }
  </style>
</head>
<body>

<div class="tx-levels">
  <button class="tx-button tx-basic" onclick="setTxLevel('basic')" id="btn-basic">Transakcje Podstawowe</button>
  <button class="tx-button tx-premium selected" onclick="setTxLevel('premium')" id="btn-premium">Transakcje Premium</button>
  <button class="tx-button tx-plat" onclick="setTxLevel('plat')" id="btn-plat">Transakcje Platynowe</button>
</div>

<div id="messageBox">
  <protected>
    Witam w Votinga. Wszystkie transakcje na blockchainie są nieodwracalne.
  </protected><br><br>
  <protected><h1>Zdecentralizowana konfirmacja, że danego adresu używa człowiek.</h1></protected>
  <protected><h2>Przed rozpoczęciem tworzenia profilu wymagane jest potwierdzenie adresu, że go kontrolujesz jako człowiek.</h2></protected>
  <protected><h2>Wgraj jako prośba o potwierdzenie jeden albo dwa adresy z metamask, lub innego walletu generatora ETH adresów.</h2></protected>
  <protected><h2>Zacznij tworzyć profil wpisując Unique ID i skontaktuj się z weryfikatorem, on/ona poprowadzi cię dalej.</h2></protected>
  <protected><h2>Profil będzie stworzony z tego adresu, który wiemy, że kontroluje człowiek.</h2></protected>
  <protected><h2>Zainstaluj metamask (lub inny wallet), stwórz klucze, użyj metamask by połączyć się z siecią blockchain: Optimistic Ethereum</h2></protected>
  <protected><h2>chain ID:10 , na stronie: https://chainlist.org/chain/10 są alternatywne rpc/serwery jeśli jest problem z połączeniem</h2></protected>
</div>

<h1>Weryfikacja człowieczeństwa przypisanego do adresu portfela</h1>
<select id="abiSelector"></select>
<button onclick="loadSelectedContract()">Załaduj kontrakt i funkcję weryfikującą</button>
<div id="contractFunctions"></div>

<script src="./ethers.umd.js"></script>
<script>
const abiFolderPath = './ABIs/Polska/';
let txLevel = 'basic';

function setTxLevel(level) {
  txLevel = level;
  document.querySelectorAll('.tx-button').forEach(btn => btn.classList.remove('selected'));
  document.getElementById('btn-' + level).classList.add('selected');
}

async function listABIs() {
  const files = ['0xa029c1c1710fc74dbeb125ce02c9a3469ca8079f.PLProsbaOpotwierdzenieAdresu.abi'];
  const selector = document.getElementById('abiSelector');
  files.forEach(file => {
    const option = document.createElement('option');
    option.value = file;
    option.innerText = file.split('.abi')[0];
    selector.appendChild(option);
  });
}

async function loadSelectedContract() {
  const selector = document.getElementById('abiSelector');
  const abiFile = selector.value;
  const contractAddress = abiFile.split('.')[0];
  const contractABI = await fetch(abiFolderPath + abiFile).then(response => response.json());
  loadContractFunctions(contractAddress, contractABI);
}

async function loadContractFunctions(contractAddress, contractABI) {
  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const contract = new ethers.Contract(contractAddress, contractABI, signer);

  const container = document.getElementById('contractFunctions');
  container.innerHTML = '';
  contractABI.forEach(func => {
    if (func.type === "function") {
      const funcDiv = document.createElement('div');
      funcDiv.className = func.stateMutability;

      const button = document.createElement('button');
      button.textContent = func.name;
      button.className = func.stateMutability;

      const inputsDiv = document.createElement('div');
      func.inputs.forEach(input => {
        const inputLabel = document.createElement('label');
        inputLabel.textContent = input.name + ' (' + input.type + '): ';
        const inputElement = document.createElement('input');
        inputElement.setAttribute('id', func.name + '_' + input.name);
        inputElement.setAttribute('type', 'text');
        inputsDiv.appendChild(document.createElement('br'));
        inputsDiv.appendChild(inputLabel);
        inputsDiv.appendChild(inputElement);
      });

      button.addEventListener('click', async () => {
        const args = func.inputs.map(input => {
          return document.getElementById(func.name + '_' + input.name).value;
        });

        try {
          let result;
          if (func.stateMutability !== 'view' && func.stateMutability !== 'pure') {
            let value;
            if (txLevel === 'premium') value = ethers.parseEther("0.0005");
            else if (txLevel === 'plat') value = ethers.parseEther("0.021");
            else value = ethers.parseEther("0");
            result = await contract[func.name](...args, { value });
          } else {
            result = await contract[func.name](...args);
          }

          let formatted = typeof result === 'object'
            ? JSON.stringify(result, null, 2)
            : String(result);
          formatted = formatted
            .replace(/{/g, '\n{\n')
            .replace(/}/g, '\n}\n')
            .replace(/,/g, '\n')
            .replace(/\[/g, '\n[\n')
            .replace(/\]/g, '\n]\n');
          document.getElementById('messageBox').innerText = formatted;
        } catch (error) {
          document.getElementById('messageBox').innerText = 'Error: ' + error.message;
        }
      });

      funcDiv.appendChild(button);
      funcDiv.appendChild(inputsDiv);
      container.appendChild(funcDiv);
    }
  });
}

window.addEventListener('DOMContentLoaded', async () => {
  listABIs();
  try {
    if (!window.ethereum) return;
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    const address = await signer.getAddress();
    const balance = await provider.getBalance(address);
    const ethBalance = parseFloat(ethers.formatEther(balance));

    if (ethBalance < 0.002) {
      setTxLevel('basic');
    } else if (ethBalance >= 0.002 && ethBalance < 0.2) {
      setTxLevel('premium');
    } else {
      setTxLevel('plat');
    }
  } catch (err) {
    console.warn("Błąd pobierania salda:", err.message);
  }
});
</script>

<a href="./index.html" id="returnButton">← Powrót do strony głównej</a>

<footer>
  <p>Sprawdź status człowieczeństwa przypisanego do adresu portfela w sieci <b>Optimism</b>.</p>
  <p>Upewnij się, że Twój adres ma odpowiednie poświadczenia profilu i został pozytywnie zweryfikowany.</p>
  <a href="https://optimistic.etherscan.io//">Optimistic etherscan</a> |
  <a href="https://optimism.blockscout.com/">Optimistic block scout</a>
</footer>

</body>
</html>
